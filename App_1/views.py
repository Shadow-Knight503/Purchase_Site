from django.shortcuts import render
from bs4 import BeautifulSoup
import requests
from urllib.parse import quote_plus
from . import models

BASE_URL = "https://kerala.craigslist.org/d/housing/search/?query={}"
BASE_IMAGE_URL = 'https://images.craigslist.org/{}_300x300.jpg'


# Create your views here.
def home(request):
    return render(request, 'base.html')


def new_search(request):
    search = request.POST.get('search')
    models.Search.objects.create(search=search)
    final_url = BASE_URL.format(quote_plus(search))
    response = requests.get(final_url)
    data = response.text
    soup = BeautifulSoup(data, features='html.parser')

    post_listings = soup.find_all('li', {'class': 'result-row'})

    final_postings = []

    for post in post_listings:
        post_title = post.find(class_='result-title').text
        post_url = post.find('a').get('href')

        if post.find(class_='result-price'):
            post_price = post.find(class_='result-price').text
        else:
            post_price = 'N/A'

        if post.find(class_='result-image').get('data-ids'):
            post_image_id = post.find(class_='result-image').get('data-ids').split(',')[0].split(':')[1]
            post_image_url = BASE_IMAGE_URL.format(post_image_id)
            print(post_image_url)
        else:
            post_image_url = 'data:image/png;base64,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'

        final_postings.append((post_title, post_url, post_price, post_image_url))

    stuff_for_frontend = {
        'search': search,
        'final_postings': final_postings,
    }

    return render(request, 'App_1/new_search.html', stuff_for_frontend)
